# PROJECT_LOG.md

- **Date:** 2026-02-08 (Pacific/Auckland)
- **Task:** Add student licence front/back photo upload + profile gallery viewer
- **Summary:**
  - Added student licence photo upload support in the student feature API/query layer with storage upload + signed URL persistence (`license_front_image_url`, `license_back_image_url`).
  - Added Supabase migration `017_students_license_images.sql` and storage policy script for private `student-licenses` bucket paths (`<organization_id>/<student_id>/<front|back>.<ext>`).
  - Updated `New/Edit student` screen to let users take photo or choose from library for front/back licence card images, preview selected images, and upload them when saving.
  - Updated `Student Profile` to display licence image thumbnails and open a maximized modal viewer with next/previous and close controls.
- **Files changed:**
  - src/features/students/api.ts
  - src/features/students/queries.ts
  - src/navigation/screens/StudentEditScreen.tsx
  - src/navigation/screens/StudentDetailScreen.tsx
  - src/supabase/types.ts
  - supabase/migrations/017_students_license_images.sql
  - supabase/storage/student-licenses.sql
  - supabase/README.md
  - PROJECT_LOG.md
  - docs/logs/PROJECT_LOG_ARCHIVE.md
- **Commands run:**
  - Get-Content -Raw AGENTS.md
  - Get-Content -Raw PROJECT_LOG.md
  - Get-Content -Raw docs/logs/INDEX.md
  - Get-Content -Raw docs/logs/PROJECT_LOG_ARCHIVE.md
  - mcp__context7__resolve-library-id (expo-image-picker)
  - mcp__context7__query-docs (/websites/expo_dev)
  - npx prettier --write src/navigation/screens/StudentEditScreen.tsx src/navigation/screens/StudentDetailScreen.tsx
  - npx tsc --noEmit
- **How to verify:**
  - Apply `supabase/migrations/017_students_license_images.sql` and run `supabase/storage/student-licenses.sql` in Supabase.
  - In `Students` -> `New student`, set required fields, open `Front photo options` / `Back photo options`, choose camera or library images, save student, and confirm profile shows both images.
  - In `Students` -> open an existing student -> `Edit`, replace front/back images, save, and confirm profile thumbnails update.
  - In `Student Profile`, tap a licence image and confirm the fullscreen modal opens, `Next`/`Previous` switches images, and `Close` exits.
  - Run `npx tsc --noEmit` and confirm no type errors.

---

- **Date:** 2026-02-08 (Pacific/Auckland)
- **Task:** Refine student assignment dropdown + organization show-all order + profile action placement
- **Summary:**
  - Updated `New student` owner/admin assignment UX to use an instructor dropdown instead of listing all instructor buttons.
  - Added a left-aligned trigger button label (`Assign new student to an Instructor`) with centered dropdown choices and centered selected state text.
  - Added fallback behavior for owner/admin create flow: if no instructors exist in the organization, the Assigned Instructor block is hidden and assignment defaults to the logged-in user.
  - Updated Students organization filtering with `Show all` and `Other's (not listed)` options; `Show all` now excludes `Private` and orders results as `Other's (not listed)` -> `Renaissance` -> `Lifeskill` -> `UMMA Trust`.
  - Removed `1H` from Class held options on `New/Edit student`.
  - Removed the `Danger zone` container and moved `Archive/Delete student` actions back to the bottom action stack under `Assessment History` with spacing.
- **Files changed:**
  - src/navigation/screens/StudentEditScreen.tsx
  - src/navigation/screens/StudentsListScreen.tsx
  - src/navigation/screens/StudentDetailScreen.tsx
  - PROJECT_LOG.md
  - docs/logs/PROJECT_LOG_ARCHIVE.md
- **Commands run:**
  - Get-Content -Raw AGENTS.md
  - Get-Content -Raw PROJECT_LOG.md
  - Get-Content -Raw docs/logs/INDEX.md
  - rg --line-number "organization|assignedInstructorId|classHeld|Danger zone" src/navigation/screens
  - npx tsc --noEmit
  - git diff -- src/navigation/screens/StudentEditScreen.tsx src/navigation/screens/StudentsListScreen.tsx src/navigation/screens/StudentDetailScreen.tsx
- **How to verify:**
  - Open `Students` -> `New student` as owner/admin with instructors in org; confirm `Assigned Instructor` shows dropdown trigger text `Assign new student to an Instructor`, left aligned.
  - Tap the trigger and confirm instructor options render as centered buttons; select one and confirm selected text updates.
  - Test owner/admin org with no instructors and confirm `Assigned Instructor` block is hidden and save still works.
  - Open `Students`, toggle `By organization` to `On`, choose `Show all`, and confirm `Private` students are excluded and group ordering follows `Other's (not listed)` -> `Renaissance` -> `Lifeskill` -> `UMMA Trust`.
  - Open `New/Edit student` and confirm `Class held` no longer shows `1H`.
  - Open `Student Profile` and confirm Archive/Delete buttons are at the bottom under `Assessment History` with spacing.
  - Run `npx tsc --noEmit` and confirm no type errors.

---

- **Date:** 2026-02-08 (Pacific/Auckland)
- **Task:** Add student organization field + list filtering
- **Summary:**
  - Added `Organization` input to `New/Edit student` directly below Address, with quick-pick options (`Private`, `UMMA Trust`, `Renaissance`, `Lifeskill`) plus `Custom` modal entry.
  - Persisted `organization_name` in students CRUD payloads and added schema/type support across form validation and Supabase table typings.
  - Added `students.organization_name` migration (`016`) with backfill/default/not-null/check/index updates.
  - Added Students screen organization filter toggle (`Off/On`) with organization selection options and filtering behavior.
  - Updated Name sorting in Students list to sort by first name first (then last name).
  - Moved archive/delete actions into a bottom `Danger zone` section on Student Profile and displayed organization there.
- **Files changed:**
  - src/features/students/constants.ts
  - src/features/students/schemas.ts
  - src/navigation/screens/StudentEditScreen.tsx
  - src/navigation/screens/StudentsListScreen.tsx
  - src/navigation/screens/StudentDetailScreen.tsx
  - src/supabase/types.ts
  - supabase/migrations/016_students_organization_name.sql
  - supabase/README.md
  - PROJECT_LOG.md
  - docs/logs/PROJECT_LOG_ARCHIVE.md
- **Commands run:**
  - Get-Content -Raw AGENTS.md
  - Get-Content -Raw PROJECT_LOG.md
  - Get-Content -Raw docs/logs/INDEX.md
  - Get-Content -Raw docs/logs/PROJECT_LOG_ARCHIVE.md
  - rg --line-number "organization|students|StudentEditScreen|StudentsListScreen|StudentDetailScreen" src supabase
  - mcp__context7__resolve-library-id (react-native)
  - mcp__context7__query-docs (/websites/reactnative_dev)
  - npx tsc --noEmit
- **How to verify:**
  - Open `Students` -> `New student` and confirm `Organization` appears below Address with listed options and a `Custom` modal flow.
  - Save a new student with each organization type (preset + custom), reopen edit/detail screens, and confirm value persists.
  - Open `Students` list, set `By organization` to `On`, select an organization, and confirm only matching students display.
  - Switch Sort to `Name` and confirm list is ordered by first name (then last name).
  - Open a Student Profile and confirm `Archive/Delete` actions are in the bottom `Danger zone` section.
  - Run `npx tsc --noEmit` and confirm no type errors.

---

- **Date:** 2026-02-08 (Pacific/Auckland)
- **Task:** App-wide tablet keyboard avoidance for bottom-half inputs
- **Summary:**
  - Updated shared `Screen` keyboard behavior so tablet portrait keyboard avoidance now applies to both scroll and non-scroll screens.
  - Lowered tablet detection threshold from `768` to `600` width to cover common Android tablet sizes.
  - Wrapped `Google Maps` screen with `KeyboardAvoidingView` so its input surfaces follow the same tablet keyboard behavior as shared-screen routes.
- **Files changed:**
  - src/components/Screen.tsx
  - src/navigation/screens/GoogleMapsScreen.tsx
  - PROJECT_LOG.md
  - docs/logs/PROJECT_LOG_ARCHIVE.md
- **Commands run:**
  - Get-Content -Raw AGENTS.md
  - Get-Content -Raw PROJECT_LOG.md
  - Get-Content -Raw docs/logs/INDEX.md
  - rg -n "keyboard|KeyboardAvoiding|softwareKeyboard|TextInput|input field|hide(s)? input|placeholder|KeyboardAware|adjustResize" docs/logs/PROJECT_LOG_ARCHIVE.md PROJECT_LOG.md
  - rg -n "KeyboardAvoidingView|keyboardShouldPersistTaps|ScrollView|SafeAreaView|TextInput|softwareKeyboardLayoutMode|android.*keyboard|adjustResize" src app.config.ts app.json package.json -g "*.ts" -g "*.tsx" -g "*.json"
  - Get-Content -Raw src/components/Screen.tsx
  - mcp__context7__resolve-library-id (expo)
  - mcp__context7__query-docs (/websites/expo_dev)
  - mcp__context7__resolve-library-id (react-native)
  - mcp__context7__query-docs (/websites/reactnative_dev)
  - npx expo config --type public
  - npx tsc --noEmit
  - git diff -- src/components/Screen.tsx src/navigation/screens/GoogleMapsScreen.tsx
- **How to verify:**
  - On tablet portrait, open any form screen and focus an input in the lower half of the screen.
  - Confirm the screen content shifts above the keyboard and the focused input remains visible while typing.
  - Verify this on both screens that use shared `Screen` and `Google Maps` search input.
  - Recheck key form screens: `Edit details`, `New/Edit student`, `New/Edit lesson`, `Assessments` screens.

---

- **Date:** 2026-02-08 (Pacific/Auckland)
- **Task:** Google Maps pin color categories + configurable defaults
- **Summary:**
  - Added marker color categories on Google Maps so pins are visually differentiated for active students, other instructor's students, custom pins, and the draft/new pin marker.
  - Added a Pin colors editor in the top Google Maps panel with color swatches, plus a Reset action.
  - Added per-user/per-organization persistence for pin color defaults using AsyncStorage so selected defaults remain after app restarts.
  - Updated marker rendering to resolve color by pin category instead of a single hardcoded color.
- **Files changed:**
  - src/navigation/screens/GoogleMapsScreen.tsx
  - PROJECT_LOG.md
  - docs/logs/PROJECT_LOG_ARCHIVE.md
- **Commands run:**
  - Get-Content -Raw AGENTS.md
  - Get-Content -Raw PROJECT_LOG.md
  - Get-Content -Raw docs/logs/INDEX.md
  - rg -n "GoogleMapsScreen|Marker|pinColor|map pins|custom pin|student" src/navigation/screens src/features -g "*.ts" -g "*.tsx"
  - mcp__context7__resolve-library-id (react-native-maps)
  - npx tsc --noEmit
  - git status --short
  - git diff -- src/navigation/screens/GoogleMapsScreen.tsx
- **How to verify:**
  - Open drawer -> Google Maps.
  - Confirm existing pins render with different colors for active student pins, other instructor student pins, and custom pins.
  - Add a new draft pin and confirm draft marker color is distinct.
  - In the top card, open Pin colors -> Edit and change each category color; confirm markers update immediately.
  - Close and reopen the app, then return to Google Maps and confirm chosen pin colors persist.

---

- **Date:** 2026-02-07 (Pacific/Auckland)
- **Task:** Students pagination, assessment dropdown picker, optional driving scoring UX, and lesson/profile count badges
- **Summary:**
  - Added a new reusable assessment student dropdown with search and scrollable list behavior, showing up to 6 visible rows, alphabetized with the logged-in instructor students first and other instructors students after.
  - Replaced the old button-list student selectors in all three assessment start screens with the dropdown flow.
  - Updated Driving Assessment scoring UX to support explicit N/A per criterion and clarified total scoring as based on answered criteria; updated feedback suggestion chips to multi-select toggle behavior for Strengths, Improvements, Recommendation, and Next steps.
  - Added students paging at 10 per page with chevron controls and bottom centered Page x / y navigator; top-right chevrons appear on the owner row.
  - Replaced Class held text input with toggle buttons (1L, 1R, 1H, 1F) on Add/Edit Student.
  - Added count badges for Session/Assessment history buttons on Student Profile and count badges on Assessment History tabs.
  - Updated Home lessons widget to show only the current owner/admin instructor lessons (not other instructors students) and renamed heading to Lessons Today.
  - Extended AppButton to support optional icon badge counts for reuse across profile/history surfaces.
- **Files changed:**
  - src/navigation/components/AssessmentStudentDropdown.tsx
  - src/components/AppButton.tsx
  - src/navigation/screens/DrivingAssessmentScreen.tsx
  - src/navigation/screens/RestrictedMockTestScreen.tsx
  - src/navigation/screens/FullLicenseMockTestScreen.tsx
  - src/navigation/screens/StudentsListScreen.tsx
  - src/navigation/screens/StudentEditScreen.tsx
  - src/navigation/screens/StudentDetailScreen.tsx
  - src/navigation/screens/StudentAssessmentHistoryScreen.tsx
  - src/navigation/screens/HomeScreen.tsx
  - PROJECT_LOG.md
  - docs/logs/PROJECT_LOG_ARCHIVE.md
- **Commands run:**
  - Get-Content -Raw AGENTS.md
  - Get-Content -Raw PROJECT_LOG.md
  - Get-Content -Raw docs/logs/INDEX.md
  - 
g -n "StudentsListScreen|DrivingAssessmentScreen|RestrictedMockTestScreen|FullLicenseMockTestScreen|StudentDetailScreen|StudentAssessmentHistoryScreen|HomeScreen" src -g "*.tsx"
  - mcp__context7__resolve-library-id (react-native)
  - mcp__context7__query-docs (/websites/reactnative_dev)
  - 
px tsc --noEmit
  - git status --short
  - git diff --stat
  - PowerShell log rotation script (append new entry + keep latest 20)
- **How to verify:**
  - Open Students and confirm only 10 students render per page, top-right chevrons are shown on the owner row, and the bottom centered pager reads Page x / y with working left/right navigation.
  - Open each assessment start screen (Driving Assessment, Mock Test - Restricted Licence, Mock Test - Full License) and confirm student selection is via dropdown with search and scrollable list (6 visible rows), ordered as your students first then other instructors.
  - In Driving Assessment test stage, mark one criterion N/A, confirm total percent remains based on answered criteria, and verify feedback suggestions toggle multiple selected lines in each feedback field.
  - Open Students -> New/Edit student and confirm Class held shows 4 toggle buttons: 1L, 1R, 1H, 1F.
  - Open a Student Profile and confirm badge counts appear on Session History and Assessment History buttons; open Assessment History and confirm badge counts appear on all three tabs.
  - Open Home as owner/admin and confirm lessons shown in Lessons Today / Next 3 days belong only to the logged-in instructor.
  - Run 
px tsc --noEmit and confirm no type errors.

---

- **Date:** 2026-02-07 (Pacific/Auckland)
- **Task:** Group other instructors' students in assessment pickers
- **Summary:**
  - Updated `Driving Assessment`, `Mock Test - Restricted Licence`, and `Mock Test - Full License` student pickers so owner/admin `Show` mode no longer mixes all students in one list.
  - Added grouped picker layout in `Show` mode: `Your students` block first, followed by separate instructor blocks below, each labeled with the designated instructor name.
  - Added organization profile lookups in those screens to resolve instructor display names from `assigned_instructor_id`.
  - Kept `Hide` mode behavior unchanged (owner/admin see only self-assigned students), and kept instructor behavior unchanged.
- **Files changed:**
  - `src/navigation/screens/DrivingAssessmentScreen.tsx`
  - `src/navigation/screens/RestrictedMockTestScreen.tsx`
  - `src/navigation/screens/FullLicenseMockTestScreen.tsx`
  - `PROJECT_LOG.md`
  - `docs/logs/PROJECT_LOG_ARCHIVE.md`
- **Commands run:**
  - `Get-Content -Raw AGENTS.md`
  - `Get-Content -Raw PROJECT_LOG.md`
  - `Get-Content -Raw docs/logs/INDEX.md`
  - `Get-Content -Raw docs/logs/PROJECT_LOG_ARCHIVE.md`
  - `rg -n "assigned_instructor_id|useStudentsQuery|Student" src/navigation/screens/*.tsx src/features/students/api.ts src/features/profiles/api.ts`
  - `mcp__context7__resolve-library-id (react)`
  - `mcp__context7__query-docs (/websites/react_dev)`
  - `npx tsc --noEmit`
  - `git status --short`
  - `git diff --stat src/navigation/screens/DrivingAssessmentScreen.tsx src/navigation/screens/RestrictedMockTestScreen.tsx src/navigation/screens/FullLicenseMockTestScreen.tsx`
- **How to verify:**
  - Open each assessment screen as owner/admin and switch `Other Instructor's Students` to `Show`.
  - Confirm the picker renders `Your students` first, then additional block containers below labeled by instructor name.
  - Confirm students are not mixed across blocks.
  - Switch back to `Hide` and confirm only self-assigned students are listed.
  - Run `npx tsc --noEmit` and confirm no type errors.

---

- **Date:** 2026-02-07 (Pacific/Auckland)
- **Task:** Assessments student filtering toggle + full mock optional spoken fields
- **Summary:**
  - Updated all three assessment student selectors (`Driving Assessment`, `Mock Test - Restricted Licence`, `Mock Test - Full License`) so owner/admin default view hides other instructors' students.
  - Added a right-aligned `Other Instructor's Students` segmented toggle (`Hide`/`Show`) on the same row as the `Student` heading in those three assessment screens.
  - Kept instructor behavior unchanged and applied filtering only to owner/admin by matching `assigned_instructor_id` to the current user when toggle is `Hide`.
  - In `Mock Test - Full License`, made `Hazard(s) spoken` and `Action spoken` optional by removing blocking validation checks and updating field labels to optional.
  - Updated Students screen owner toggle label text from `View Instructor's Students` to `View other instructor's students`.
- **Files changed:**
  - `src/navigation/screens/DrivingAssessmentScreen.tsx`
  - `src/navigation/screens/RestrictedMockTestScreen.tsx`
  - `src/navigation/screens/FullLicenseMockTestScreen.tsx`
  - `src/navigation/screens/StudentsListScreen.tsx`
  - `PROJECT_LOG.md`
  - `docs/logs/PROJECT_LOG_ARCHIVE.md`
- **Commands run:**
  - `rg -n "Hazard\(s\) spoken|Action spoken|studentsQuery|Student" src/navigation/screens src/features/assessments`
  - `mcp__context7__resolve-library-id (react)`
  - `mcp__context7__query-docs (/websites/react_dev)`
  - `npx tsc --noEmit`
  - `git status --short`
  - `git diff --stat src/navigation/screens/DrivingAssessmentScreen.tsx src/navigation/screens/RestrictedMockTestScreen.tsx src/navigation/screens/FullLicenseMockTestScreen.tsx src/navigation/screens/StudentsListScreen.tsx`
- **How to verify:**
  - Open each assessment screen as owner/admin and confirm `Other Instructor's Students` toggle appears on the Student header row, defaulting to `Hide`.
  - With toggle on `Hide`, confirm only self-assigned students are listed; switch to `Show` and confirm additional instructor-assigned students appear.
  - Open `Mock Test - Full License` and confirm `Hazard(s) spoken` and `Action spoken` labels display `(optional)` and attempts can be recorded without entering those fields.
  - Open `Students` as owner/admin and confirm label now reads `View other instructor's students`.
  - Run `npx tsc --noEmit` and confirm no type errors.

---

- **Date:** 2026-02-07 (Pacific/Auckland)
- **Task:** Refactor Batch 2+3: query invalidation helpers + shared async UI states
- **Summary:**
  - Added `invalidateQueriesByKey` helper to centralize parallel React Query cache invalidation calls and reduced duplicated invalidation blocks in account/profile/student/lesson mutations.
  - Added reusable async-state UI primitives (`CenteredLoadingState`, `ErrorStateCard`, `EmptyStateCard`) for consistent loading/error/empty rendering.
  - Refactored `Home`, `Lessons`, `Students`, and `View Members` screens to use shared async-state components without changing routes, feature behavior, or API contracts.
  - Introduced low-risk key constants/helpers (`students`/`lessons` roots and `profileKeys.memberRoot`) to remove repeated raw query-key arrays.
- **Files changed:**
  - `src/utils/query.ts`
  - `src/features/account/queries.ts`
  - `src/features/profiles/queries.ts`
  - `src/features/students/queries.ts`
  - `src/features/lessons/queries.ts`
  - `src/components/AsyncState.tsx`
  - `src/navigation/screens/HomeScreen.tsx`
  - `src/navigation/screens/LessonsListScreen.tsx`
  - `src/navigation/screens/StudentsListScreen.tsx`
  - `src/navigation/screens/ViewMembersScreen.tsx`
  - `PROJECT_LOG.md`
  - `docs/logs/PROJECT_LOG_ARCHIVE.md`
- **Commands run:**
  - `rg -n "invalidateQueries\(|isPending|ActivityIndicator" src/features src/navigation/screens`
  - `mcp__context7__resolve-library-id (@tanstack/react-query)`
  - `mcp__context7__query-docs (/tanstack/query/v5.71.10)`
  - `npx tsc --noEmit`
  - `npm run lint` (fails: missing `lint` script in `package.json`)
  - `npm run`
  - `git status --short`
  - `git diff --stat`
- **How to verify:**
  - Run `npx tsc --noEmit` and confirm no TypeScript errors.
  - Open `Home` and confirm lessons loading/error states and retry action behave as before.
  - Open `Lessons` list and confirm loading state still appears while monthly lessons fetch.
  - Open `Students` and verify loading/error/empty cards still display the same messages and retry behavior for both main list and owner/admin member-dependent blocks.
  - Open `Settings` -> `View members` and confirm loading/error/retry behavior is unchanged.

---

- **Date:** 2026-02-07 (Pacific/Auckland)
- **Task:** Batch 1 refactor: dead code cleanup + type safety hardening
- **Summary:**
  - Removed unreachable navigation/screen code (`MainTabsNavigator`, `EditNameScreen`) and related unused account name-update schema/query/api paths.
  - Replaced remaining real `any` usages with typed alternatives in weather parsing and driving-assessment RHF field-path wiring.
  - Cleared strict-TypeScript unused symbols in large screens and Supabase client imports without changing runtime behavior.
- **Files changed:**
  - `src/features/account/api.ts`
  - `src/features/account/queries.ts`
  - `src/features/account/schemas.ts`
  - `src/features/weather/api.ts`
  - `src/navigation/screens/DrivingAssessmentScreen.tsx`
  - `src/navigation/screens/FullLicenseMockTestScreen.tsx`
  - `src/navigation/screens/GoogleMapsScreen.tsx`
  - `src/navigation/screens/StudentAssessmentHistoryScreen.tsx`
  - `src/navigation/MainTabsNavigator.tsx` (deleted)
  - `src/navigation/screens/EditNameScreen.tsx` (deleted)
  - `src/supabase/client.ts`
  - `PROJECT_LOG.md`
  - `docs/logs/PROJECT_LOG_ARCHIVE.md`
- **Commands run:**
  - `git status -sb`
  - `mcp__context7__resolve-library-id (react-hook-form)`
  - `mcp__context7__query-docs (/react-hook-form/documentation)`
  - `npx tsc --noEmit`
  - `npx tsc --noEmit --noUnusedLocals --noUnusedParameters`
- **How to verify:**
  - Run `npx tsc --noEmit` and confirm no type errors.
  - Run `npx tsc --noEmit --noUnusedLocals --noUnusedParameters` and confirm no unused symbol errors.
  - Open `Assessments` -> `Driving Assessment` and verify score buttons still save values for all criteria.
  - Open `Assessments` -> `Full License Mock Test` and `Students` -> `Assessment History` and confirm screens load normally.

---

- **Date:** 2026-02-07 (Pacific/Auckland)
- **Task:** Add drawer sign-out with confirmation
- **Summary:**
  - Added a `Sign out` action in the sidebar menu above the bottom divider/settings block.
  - Added a confirmation alert (`Cancel` / `Sign out`) before signing out.
  - On confirmation, triggers auth sign-out so the app returns to the login flow.
- **Files changed:**
  - `src/navigation/components/AppDrawerContent.tsx`
  - `PROJECT_LOG.md`
  - `docs/logs/PROJECT_LOG_ARCHIVE.md`
- **Commands run:**
  - `npx tsc --noEmit`
- **How to verify:**
  - Open the drawer and confirm `Sign out` appears above the divider and `Settings`.
  - Tap `Sign out` and confirm the confirmation alert appears.
  - Tap `Cancel` and confirm you remain signed in.
  - Tap `Sign out` in the alert and confirm you are returned to `LoginScreen`.

---

- **Date:** 2026-02-07 (Pacific/Auckland)
- **Task:** Add delete actions and save confirmations for students/lessons
- **Summary:**
  - Excluded `admin` from assignable instructor options on `New student` and `New lesson` screens.
  - Added save confirmations for `Edit student` and for both `New lesson`/`Edit lesson` submissions.
  - Added permanent `Delete student` action on student profile and icon-only `Delete lesson` action on edit lesson header.
  - Added student/lesson delete API + query mutations and new RLS delete policies migration.
- **Files changed:**
  - `src/navigation/screens/StudentEditScreen.tsx`
  - `src/navigation/screens/LessonEditScreen.tsx`
  - `src/navigation/screens/StudentDetailScreen.tsx`
  - `src/features/students/api.ts`
  - `src/features/students/queries.ts`
  - `src/features/lessons/api.ts`
  - `src/features/lessons/queries.ts`
  - `supabase/migrations/011_students_lessons_delete_policies.sql`
  - `supabase/README.md`
  - `PROJECT_LOG.md`
  - `docs/logs/PROJECT_LOG_ARCHIVE.md`
- **Commands run:**
  - `npx tsc --noEmit`
- **How to verify:**
  - New student/new lesson: confirm admin users are not shown in assignable instructor options.
  - Edit student: tap `Save student` and confirm a save confirmation appears before update.
  - New/edit lesson: tap save/create and confirm confirmation appears before mutation.
  - Student profile: confirm red `Delete student` appears below archive/unarchive and deletes after confirmation.
  - Edit lesson: confirm top-right icon-only delete button appears and deletes after confirmation.
  - Apply `supabase/migrations/011_students_lessons_delete_policies.sql` before testing deletes against Supabase.

---

- **Date:** 2026-02-07 (Pacific/Auckland)
- **Task:** Refactor AGENTS.md using full project log history
- **Summary:**
  - Reviewed all entries in `PROJECT_LOG.md` and `docs/logs/PROJECT_LOG_ARCHIVE.md` to align instructions with current implemented behavior.
  - Replaced the oversized spec-style `AGENTS.md` with a concise operations guide focused on current app reality and durable working rules.
  - Preserved mandatory workflow items (MCP lookup expectations, migrations process, log/commit/verification requirements) while removing outdated or redundant sections.
- **Files changed:**
  - `AGENTS.md`
  - `PROJECT_LOG.md`
  - `docs/logs/INDEX.md`
  - `docs/logs/PROJECT_LOG_ARCHIVE.md`
- **Commands run:**
  - `Get-Content -Raw AGENTS.md`
  - `Get-Content -Raw PROJECT_LOG.md`
  - `Get-Content -Raw docs/logs/PROJECT_LOG_ARCHIVE.md`
  - `rg --no-heading "^- \\*\\*Date:\\*\\*|^- \\*\\*Task:\\*\\*" PROJECT_LOG.md docs/logs/PROJECT_LOG_ARCHIVE.md`
- **How to verify:**
  - Open `AGENTS.md` and confirm it is significantly shorter and references current roles (`owner`, `admin`, `instructor`) and current feature baseline.
  - Confirm `PROJECT_LOG.md` still contains 20 entries and includes this new entry at the bottom.
  - Confirm the oldest previously active entry now exists in `docs/logs/PROJECT_LOG_ARCHIVE.md`.

---

- **Date:** 2026-02-07 (Pacific/Auckland)
- **Task:** Add Google Maps screen with persistent pins
- **Summary:**
  - Added a new drawer route Google Maps with a near full-screen interactive map view.
  - Implemented map layer switching (Default, Satellite, Hybrid) and pin creation via long-press or map-center placement.
  - Added pin labels/notes and optional student linking, backed by a new tenant-safe map_pins table with RLS.
  - Added map pin API/query hooks and marker selection/delete support on the map screen.
  - Added optional build-time GOOGLE_MAPS_API_KEY wiring through Expo config for react-native-maps plugin setup.
- **Files changed:**
  - .env.example
  - README.md
  - app.config.ts
  - package.json
  - package-lock.json
  - src/features/map-pins/api.ts
  - src/features/map-pins/queries.ts
  - src/navigation/MainDrawerNavigator.tsx
  - src/navigation/MapsStackNavigator.tsx
  - src/navigation/components/AppDrawerContent.tsx
  - src/navigation/screens/GoogleMapsScreen.tsx
  - src/supabase/types.ts
  - supabase/migrations/012_map_pins.sql
  - supabase/README.md
  - PROJECT_LOG.md
  - docs/logs/PROJECT_LOG_ARCHIVE.md
- **Commands run:**
  - npx expo install react-native-maps
  - npx tsc --noEmit
  - npx expo config --type public
- **How to verify:**
  - Apply supabase/migrations/012_map_pins.sql in Supabase SQL Editor.
  - Set GOOGLE_MAPS_API_KEY for local/EAS builds and rebuild the app.
  - Open drawer -> Google Maps and confirm the map renders full-screen with layer toggle controls.
  - Long-press map to add a pin, enter label/notes, optionally link a student, and save.
  - Tap an existing marker to view details, then delete it and confirm it disappears.

---

- **Date:** 2026-02-07 (Pacific/Auckland)
- **Task:** Fix react-native-maps config plugin startup error
- **Summary:**
  - Removed dynamic app config plugin injection for react-native-maps, which caused Expo startup to fail.
  - Kept Google Maps key wiring in app config using native fields instead (ios config googleMapsApiKey and android config googleMaps apiKey).
  - Verified Expo config resolves without PluginError and TypeScript compile still passes.
- **Files changed:**
  - app.config.ts
  - PROJECT_LOG.md
  - docs/logs/PROJECT_LOG_ARCHIVE.md
- **Commands run:**
  - npx expo config --type public
  - npx tsc --noEmit
- **How to verify:**
  - Run npm start and confirm startup no longer throws PluginError for react-native-maps.
  - Open the Google Maps screen from the drawer and confirm map renders.

---

- **Date:** 2026-02-07 (Pacific/Auckland)
- **Task:** Add anchored vectors, snapshots, and student address auto-pin in Google Maps
- **Summary:**
  - Added persistent map annotations with two modes: anchored vector drawings (lat/lng polylines) and snapshot annotations (map capture + doodle overlay).
  - Added annotation data layer and query hooks plus a new Supabase migration/table for multi-tenant annotation storage with role-safe RLS policies.
  - Added snapshot annotation editor modal and snapshot preview modal with stroke rendering.
  - Added Auto-pin action that geocodes all active students with addresses and creates map pins for students not already pinned.
  - Updated the Google Maps screen to render saved vector overlays, create/delete annotations, and expose the new annotation workflows.
- **Files changed:**
  - README.md
  - supabase/README.md
  - supabase/migrations/013_map_annotations.sql
  - src/supabase/types.ts
  - src/features/map-annotations/api.ts
  - src/features/map-annotations/queries.ts
  - src/features/map-annotations/codec.ts
  - src/navigation/components/SnapshotAnnotationModal.tsx
  - src/navigation/components/SnapshotPreviewModal.tsx
  - src/navigation/screens/GoogleMapsScreen.tsx
  - PROJECT_LOG.md
  - docs/logs/PROJECT_LOG_ARCHIVE.md
- **Commands run:**
  - npx tsc --noEmit
- **How to verify:**
  - Apply supabase/migrations/013_map_annotations.sql in Supabase SQL Editor.
  - Open drawer -> Google Maps, select a pin, tap Anchored vector, draw on map, and save; confirm saved lines re-render when reopening the pin.
  - Select a pin, tap Snapshot, draw over the captured image, save, then tap the snapshot item to confirm preview rendering.
  - Tap Auto-pin active student addresses and confirm pins are created for active students with addresses that were not already pinned.

---

- **Date:** 2026-02-07 (Pacific/Auckland)
- **Task:** Google Maps main-map annotations + NZ address autocomplete
- **Summary:**
  - Added main-map annotation support so anchored vectors and snapshots work even when no pin is selected.
  - Added drawing controls for anchored vectors and snapshots: color, line thickness, text placement, undo, and redo.
  - Added NZ-only Google address search/autocomplete on Google Maps and zoom-to-address behavior.
  - Added reusable NZ address autocomplete input and integrated it into student address editing.
  - Extended annotation payload parsing/serialization to persist styled strokes and text labels.
- **Files changed:**
  - `.env.example`
  - `README.md`
  - `app.config.ts`
  - `src/components/AddressAutocompleteInput.tsx`
  - `src/features/maps/places.ts`
  - `src/features/map-annotations/codec.ts`
  - `src/navigation/components/SnapshotAnnotationModal.tsx`
  - `src/navigation/components/SnapshotPreviewModal.tsx`
  - `src/navigation/screens/GoogleMapsScreen.tsx`
  - `src/navigation/screens/StudentEditScreen.tsx`
  - `PROJECT_LOG.md`
  - `docs/logs/PROJECT_LOG_ARCHIVE.md`
- **Commands run:**
  - `npx tsc --noEmit`
  - `npx expo config --type public`
- **How to verify:**
  - Open `Google Maps`, type an NZ address, pick autocomplete suggestion, and confirm the map zooms to that location.
  - In `Google Maps`, use top-panel `Anchored vector` and `Snapshot` (without selecting a pin) and confirm color/width/text + undo/redo + save all work.
  - Select an existing pin and confirm the same annotation tools still work for pin-scoped annotations.
  - Open `Students` -> `New/Edit student` and confirm the Address field now shows NZ autocomplete suggestions while typing.

---

- **Date:** 2026-02-07 (Pacific/Auckland)
- **Task:** Google Maps cleanup: remove vectors + snapshot UI updates
- **Summary:**
  - Removed Anchored vector workflows from the Google Maps UI and map annotation codec, keeping snapshot annotations and pin workflows intact.
  - Updated map controls layout: removed top-right refresh, changed add button icon to Lucide `Pin`, moved layer tabs above address search, and replaced the separate search button with inline Clear beside the address input.
  - Moved snapshot capture controls into bottom annotation cards (main map + selected pin) as square icon buttons.
  - Updated Snapshot Annotation modal: added line-thickness icons beside size labels, added black as a draw color option, switched Undo/Redo to icon-only buttons, and right-aligned Save snapshot.
  - Hardened Auto-pin geocoding by trying Google geocode first (when configured), then Expo geocode fallback, and surfacing the first failure reason when insert errors occur.
- **Files changed:**
  - `src/navigation/screens/GoogleMapsScreen.tsx`
  - `src/navigation/components/SnapshotAnnotationModal.tsx`
  - `src/components/AddressAutocompleteInput.tsx`
  - `src/features/map-annotations/codec.ts`
  - `PROJECT_LOG.md`
  - `docs/logs/PROJECT_LOG_ARCHIVE.md`
- **Commands run:**
  - `npx tsc --noEmit`
  - `rg -n "anchored_vector|vector" src/navigation/screens/GoogleMapsScreen.tsx src/features/map-annotations/codec.ts`
- **How to verify:**
  - Open `Google Maps` and confirm top-right shows only one square add-pin icon button (no refresh button).
  - Confirm map layer tabs are above the address input, and the Clear button is beside the input on the right.
  - Confirm there is no Anchored vector button/workflow and no vector counts/listing in bottom cards.
  - In `Main Map Annotations`, confirm Snapshot is a right-aligned square camera icon button; tap it and save a snapshot.
  - Open Snapshot Annotation modal and confirm: black color is available, size options show an icon + px label, Undo/Redo are icon-only, and Save snapshot is right-aligned.
  - Tap `Auto-pin active student addresses` and confirm it no longer reports generic unexpected failures for geocoder path issues.

---

- **Date:** 2026-02-07 (Pacific/Auckland)
- **Task:** Center Google Maps add-pin icon button
- **Summary:**
  - Fixed shared `AppButton` icon-only layout so internal content gap is only applied when both icon and label exist.
  - This centers icon-only buttons, including the top-right Google Maps add-pin button.
- **Files changed:**
  - `src/components/AppButton.tsx`
  - `PROJECT_LOG.md`
  - `docs/logs/PROJECT_LOG_ARCHIVE.md`
- **Commands run:**
  - `Get-Content -Raw AGENTS.md`
  - `Get-Content -Raw PROJECT_LOG.md`
  - `Get-Content -Raw docs/logs/INDEX.md`
  - `rg -n "add pin|Add pin|Pin|pin" src/navigation/screens/GoogleMapsScreen.tsx`
  - `Get-Content -Raw src/navigation/screens/GoogleMapsScreen.tsx`
  - `Get-Content -Raw src/components/AppButton.tsx`
  - `Get-Content -Raw src/theme/theme.ts`
  - `npx tsc --noEmit`
- **How to verify:**
  - Open `Google Maps` screen.
  - Confirm the top-right blue add-pin button icon is visually centered.
  - Confirm other icon-only square buttons (e.g. snapshot camera) remain centered.

---

- **Date:** 2026-02-07 (Pacific/Auckland)
- **Task:** Harden icon-only button centering for map controls
- **Summary:**
  - Added a dedicated `icon` button size in shared theme/button primitives to avoid conflicting NativeWind utility classes for icon-only controls.
  - Updated icon-only buttons on Google Maps, Snapshot Annotation modal, and Lessons month navigation to use `size="icon"` instead of class-based height/width overrides.
  - This removes inherited `md` spacing conflicts and centers icons consistently inside square buttons.
- **Files changed:**
  - `src/theme/theme.ts`
  - `src/components/AppButton.tsx`
  - `src/navigation/screens/GoogleMapsScreen.tsx`
  - `src/navigation/components/SnapshotAnnotationModal.tsx`
  - `src/navigation/screens/LessonsListScreen.tsx`
  - `PROJECT_LOG.md`
  - `docs/logs/PROJECT_LOG_ARCHIVE.md`
- **Commands run:**
  - `Get-Content -Raw src/navigation/screens/GoogleMapsScreen.tsx`
  - `Get-Content -Raw src/navigation/components/SnapshotAnnotationModal.tsx`
  - `Get-Content -Raw src/features/weather/WeatherWidget.tsx`
  - `Get-Content -Raw src/components/AppButton.tsx`
  - `Get-Content -Raw src/theme/theme.ts`
  - `npx tsc --noEmit`
- **How to verify:**
  - Open `Google Maps` and confirm the top-right add-pin icon is centered inside its blue square button.
  - In `Main Map Annotations`, confirm the camera icon is centered inside its square button.
  - Open Snapshot Annotation and confirm Undo/Redo icons are centered in their square buttons.
  - Open Lessons list and confirm month nav chevron icons are centered in square controls.


