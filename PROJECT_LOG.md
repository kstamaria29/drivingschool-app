# PROJECT_LOG.md

- **Date:** 2026-02-05 (Pacific/Auckland)
- **Task:** Show upcoming lessons on Home
- **Summary:**
  - Updated the Home "Today" card to list each lesson (student full name + start/end time) instead of a count.
  - Added an "Next 3 days" section showing upcoming lessons grouped by day.
- **Files changed:**
  - `src/navigation/screens/HomeScreen.tsx`
  - `PROJECT_LOG.md`
- **Commands run:**
  - `npx tsc --noEmit`
- **How to verify:**
  - On `Home`: confirm Today's lessons list shows names + time ranges.
  - Confirm lessons for the next 3 days appear under "Next 3 days" and days with no lessons are hidden.

---

- **Date:** 2026-02-05 (Pacific/Auckland)
- **Task:** Use 12h time format on Home
- **Summary:**
  - Updated lesson time ranges on Home to use 12-hour format (e.g. `10:15 am - 10:30 am`).
- **Files changed:**
  - `src/navigation/screens/HomeScreen.tsx`
  - `PROJECT_LOG.md`
- **Commands run:**
  - `npx tsc --noEmit`
- **How to verify:**
  - On `Home`: confirm lesson time ranges show in 12-hour format with am/pm.

---

- **Date:** 2026-02-05 (Pacific/Auckland)
- **Task:** Rename Today heading on Home
- **Summary:**
  - Renamed the Home lessons card heading from "Today" to "Upcoming Lessons Today".
- **Files changed:**
  - `src/navigation/screens/HomeScreen.tsx`
  - `PROJECT_LOG.md`
- **Commands run:**
  - `npx tsc --noEmit`
- **How to verify:**
  - On `Home`: confirm the lessons card heading reads "Upcoming Lessons Today".

---

- **Date:** 2026-02-05 (Pacific/Auckland)
- **Task:** Underline next-days date headers
- **Summary:**
  - Underlined the day/date headers in the "Next 3 days" section and matched the font size to student rows.
- **Files changed:**
  - `src/navigation/screens/HomeScreen.tsx`
  - `PROJECT_LOG.md`
- **Commands run:**
  - `npx tsc --noEmit`
- **How to verify:**
  - On `Home`: confirm each day/date header in "Next 3 days" is underlined and uses the same text size as the student names.

---

- **Date:** 2026-02-05 (Pacific/Auckland)
- **Task:** Settings: Account settings + instructor creation
- **Summary:**
  - Renamed Settings "Profile" section to "Account Settings" and displays full name (first + last) when available.
  - Added profile photo actions (take photo, choose from library, remove photo).
  - Added Change Name and Change Password flows (with current/new/confirm fields).
  - Enforced first-login password change via `profiles.must_change_password` (instructors created by owner are gated until password is updated).
  - Implemented owner-only "Add Instructor" flow backed by a Supabase Edge Function that generates a temporary password.
- **Files changed:**
  - `src/navigation/screens/SettingsScreen.tsx`
  - `src/navigation/SettingsStackNavigator.tsx`
  - `src/navigation/RootNavigation.tsx`
  - `src/navigation/ForcedPasswordChangeStackNavigator.tsx`
  - `src/navigation/screens/EditNameScreen.tsx`
  - `src/navigation/screens/ChangePasswordScreen.tsx`
  - `src/navigation/screens/ForcePasswordChangeScreen.tsx`
  - `src/navigation/screens/AddInstructorScreen.tsx`
  - `src/navigation/components/HeaderButtons.tsx`
  - `src/navigation/components/AppDrawerContent.tsx`
  - `src/navigation/screens/HomeScreen.tsx`
  - `src/navigation/screens/LessonEditScreen.tsx`
  - `src/navigation/screens/StudentEditScreen.tsx`
  - `src/navigation/screens/RestrictedMockTestScreen.tsx`
  - `src/navigation/screens/FullLicenseMockTestScreen.tsx`
  - `src/navigation/screens/DrivingAssessmentScreen.tsx`
  - `src/features/account/api.ts`
  - `src/features/account/queries.ts`
  - `src/features/account/schemas.ts`
  - `src/features/account/ChangePasswordForm.tsx`
  - `src/features/instructors/api.ts`
  - `src/features/instructors/queries.ts`
  - `src/features/instructors/schemas.ts`
  - `src/utils/profileName.ts`
  - `src/supabase/types.ts`
  - `supabase/migrations/009_account_settings.sql`
  - `supabase/functions/create-instructor/index.ts`
  - `supabase/README.md`
  - `app.json`
  - `tsconfig.json`
  - `PROJECT_LOG.md`
- **Commands run:**
  - `npx tsc --noEmit`
- **How to verify:**
  - Settings -> confirm "Account Settings" heading, full name display, Change name/password buttons.
  - Settings -> Change profile photo -> confirm Take/Choose/Remove options.
  - Owner: Settings -> Instructors -> Add instructor -> create an instructor and confirm credentials are returned.
  - Sign in as the new instructor -> confirm you are forced to the password change screen until you update it.

---

- **Date:** 2026-02-06 (Pacific/Auckland)
- **Task:** Fix release build crash (Supabase env)
- **Summary:**
  - Fixed Supabase env resolution for native builds by avoiding dynamic `process.env[key]` access and supporting Expo `extra` fallback.
  - Added `app.config.ts` to surface Supabase values in `expo.extra` for builds.
  - Added an in-app "missing Supabase config" screen to prevent a hard crash when env vars are absent.
  - Documented EAS env requirements in `README.md`.
- **Files changed:**
  - `app.config.ts`
  - `src/supabase/env.ts`
  - `src/supabase/client.ts`
  - `src/features/auth/session.tsx`
  - `src/navigation/RootNavigation.tsx`
  - `src/navigation/screens/MissingSupabaseConfigScreen.tsx`
  - `README.md`
  - `PROJECT_LOG.md`
- **Commands run:**
  - `npx tsc --noEmit`
  - `npx expo config --type public`
- **How to verify:**
  - With env vars set: build/install APK and confirm it opens without crashing.
  - Without env vars set: confirm the app shows the "App misconfigured" screen instead of crashing.

---

- **Date:** 2026-02-06 (Pacific/Auckland)
- **Task:** Estimate solo-dev timeline (no AI)
- **Summary:**
  - Provided a rough full-time solo developer estimate for implementing the v1 mobile app scope end-to-end (Expo RN + Supabase + RLS + PDF export) without AI assistance.
- **Files changed:**
  - `PROJECT_LOG.md`
- **Commands run:**
  - `Get-Content AGENTS.md`
  - `Get-Content PROJECT_LOG.md`
  - `Get-Content PROJECT_LOG.md -Tail 40`
- **How to verify:**
  - Open `PROJECT_LOG.md` and confirm this entry exists at the bottom.

---

- **Date:** 2026-02-07 (Pacific/Auckland)
- **Task:** Route deleted/stale sessions to login
- **Summary:**
  - Added startup session validation against Supabase Auth (`getUser`) before trusting a restored local session.
  - Added stale-session detection (invalid JWT/missing user/auth-session-missing patterns + 401/403/404) and local sign-out cleanup.
  - Prevents deleted users with cached sessions from being routed to onboarding; they now fall back to `Login`.
- **Files changed:**
  - `src/features/auth/session.tsx`
  - `PROJECT_LOG.md`
- **Commands run:**
  - `Get-Content -Raw AGENTS.md`
  - `Get-Content -Raw PROJECT_LOG.md`
  - `npx tsc --noEmit`
- **How to verify:**
  - Delete a signed-in user in Supabase (`auth.users`) while keeping the app installed/signed in on device.
  - Reopen the app and confirm it lands on `LoginScreen` (not `OnboardingCreateOrgScreen`).
  - Create a brand-new account from `Signup` and confirm onboarding still appears for first-time org creation.

---

- **Date:** 2026-02-07 (Pacific/Auckland)
- **Task:** Add onboarding back button to login
- **Summary:**
  - Added a back action on `OnboardingCreateOrgScreen` so users can return to the sign-in screen.
  - Implemented the action with `navigation.replace("Login")` to avoid leaving onboarding on the back stack.
- **Files changed:**
  - `src/navigation/screens/OnboardingCreateOrgScreen.tsx`
  - `PROJECT_LOG.md`
- **Commands run:**
  - `Get-Content -Raw AGENTS.md`
  - `Get-Content -Tail 140 PROJECT_LOG.md`
  - `npx tsc --noEmit`
- **How to verify:**
  - Open `Create your driving school` screen.
  - Tap `Back to sign in`.
  - Confirm the app navigates to `LoginScreen`.

---

- **Date:** 2026-02-07 (Pacific/Auckland)
- **Task:** Signup email verification confirmation dialog
- **Summary:**
  - Updated `Create account` flow to show a confirmation alert after sign-up when email verification is required.
  - Alert message is `Check your email to verify your account.` and `OK` returns the user to `Login`.
  - Removed the previous inline confirmation text block from the signup screen.
- **Files changed:**
  - `src/navigation/screens/SignupScreen.tsx`
  - `PROJECT_LOG.md`
- **Commands run:**
  - `Get-Content -Raw AGENTS.md`
  - `Get-Content -Tail 120 PROJECT_LOG.md`
  - `npx tsc --noEmit`
- **How to verify:**
  - Open `Create account`, enter a new email/password, and tap `Create account`.
  - Confirm an alert appears with `Check your email to verify your account.`.
  - Tap `OK` and confirm navigation returns to `LoginScreen`.

---

- **Date:** 2026-02-07 (Pacific/Auckland)
- **Task:** Force consistent default light theme on first launch
- **Summary:**
  - Fixed theme hydration mismatch by syncing provider state and NativeWind color scheme from a single resolved value (`stored` or default `light`).
  - Added a theme-ready gate in root navigation to avoid rendering mixed themed surfaces before color scheme initialization finishes.
  - Moved status bar theme source to `ColorSchemeProvider` so it always matches app theme.
- **Files changed:**
  - `src/providers/ColorSchemeProvider.tsx`
  - `src/navigation/RootNavigation.tsx`
  - `App.tsx`
  - `PROJECT_LOG.md`
- **Commands run:**
  - `Get-Content -Raw AGENTS.md`
  - `Get-Content -Raw PROJECT_LOG.md`
  - `npx tsc --noEmit`
- **How to verify:**
  - Fresh install APK on device and launch app for the first time.
  - Confirm login/auth screens and drawer/navigation surfaces are all light mode (no mixed dark sidebar).
  - Open Settings and toggle dark mode, then relaunch app to confirm persisted mode still applies consistently.

---

- **Date:** 2026-02-07 (Pacific/Auckland)
- **Task:** Confirm before creating student + rename create CTA
- **Summary:**
  - Added a confirmation alert on `StudentCreate` submit with `Back` and `Confirm` options before persisting a new student.
  - Kept edit flow unchanged (updates still save directly).
  - Renamed create-screen primary button from `Save student` to `Add student`.
- **Files changed:**
  - `src/navigation/screens/StudentEditScreen.tsx`
  - `PROJECT_LOG.md`
- **Commands run:**
  - `Get-Content -Raw AGENTS.md`
  - `Get-Content -Raw PROJECT_LOG.md`
  - `npx tsc --noEmit`
- **How to verify:**
  - Open `Students` -> `New student`, fill required fields, and tap `Add student`.
  - Confirm alert appears with `Back` and `Confirm`.
  - Tap `Back` and verify no student is created.
  - Tap `Add student` again and then `Confirm`; verify you are navigated to the new student detail.

---

- **Date:** 2026-02-07 (Pacific/Auckland)
- **Task:** Add hazard detection and response controls to full mock test
- **Summary:**
  - Added a new `Hazard Detection and Response` section above `Assessment items (Pass/Fail)` in `Mock Test - Full License`.
  - Implemented category rows (`Pedestrians`, `Vehicles`, `Others`) with letter-box subcategories and a Yes/No/N/A modal picker.
  - Set `N/A` as the default for all hazard subcategories and color-coded selected boxes (`Yes` = green, `No` = red).
  - Enforced validation so each task attempt must include at least one non-`N/A` hazard response before recording.
  - Extended stored attempt data and PDF export to include hazard response selections.
- **Files changed:**
  - `src/navigation/screens/FullLicenseMockTestScreen.tsx`
  - `src/features/assessments/full-license-mock-test/constants.ts`
  - `src/features/assessments/full-license-mock-test/scoring.ts`
  - `src/features/assessments/full-license-mock-test/schema.ts`
  - `src/features/assessments/full-license-mock-test/pdf.ts`
  - `PROJECT_LOG.md`
- **Commands run:**
  - `Get-Content -Raw AGENTS.md`
  - `Get-Content -Raw PROJECT_LOG.md`
  - `npx tsc --noEmit`
- **How to verify:**
  - Open `Assessments` -> `Mock Test - Full License`, start a run, and go to `Record task attempt`.
  - Confirm `Hazard Detection and Response` appears above `Assessment items (Pass/Fail)`.
  - Tap hazard boxes for each category row and confirm a modal appears with `Yes`, `No`, and `N/A`.
  - Confirm selected box colors: green for `Yes`, red for `No`, neutral for `N/A`.
  - Leave all hazard boxes as `N/A`, tap `Record task attempt`, and confirm validation blocks save.
  - Set at least one hazard to `Yes` or `No`, then confirm the attempt records successfully.

---

- **Date:** 2026-02-07 (Pacific/Auckland)
- **Task:** Align full mock test hazard columns vertically
- **Summary:**
  - Updated hazard matrix layout to use fixed direction columns (`L`, `R`, `A`, `B`, `O`) for every category row.
  - Added empty placeholders for directions not used in a category so matching subcategory letters align vertically across rows.
- **Files changed:**
  - `src/navigation/screens/FullLicenseMockTestScreen.tsx`
  - `PROJECT_LOG.md`
- **Commands run:**
  - `Get-Content -Raw AGENTS.md`
  - `Get-Content -Tail 120 PROJECT_LOG.md`
  - `npx tsc --noEmit`
- **How to verify:**
  - Open `Assessments` -> `Mock Test - Full License` -> start run -> `Record task attempt`.
  - In `Hazard Detection and Response`, confirm `L` boxes are vertically aligned across `Pedestrians`, `Vehicles`, and `Others`.
  - Confirm the same vertical alignment for `R`, `A`, `B`, and `O`.

---

- **Date:** 2026-02-07 (Pacific/Auckland)
- **Task:** Archive PROJECT_LOG and enforce 30-entry cap
- **Summary:**
  - Archived older entries from `PROJECT_LOG.md` into `docs/logs/PROJECT_LOG_ARCHIVE.md`.
  - Added a 30-entry rolling cap rule and archive instructions in `AGENTS.md`.
  - Added `docs/logs/INDEX.md` to document active vs archived log paths.
- **Files changed:**
  - `AGENTS.md`
  - `PROJECT_LOG.md`
  - `docs/logs/INDEX.md`
  - `docs/logs/PROJECT_LOG_ARCHIVE.md`
- **Commands run:**
  - `Get-Content -Raw AGENTS.md`
  - `Get-Content -Raw PROJECT_LOG.md`
  - `rg --no-heading "^- \*\*Date:\*\*" PROJECT_LOG.md`
  - PowerShell archive script (move old entries + keep latest 30)
- **How to verify:**
  - Confirm `PROJECT_LOG.md` contains only the most recent 30 entries.
  - Confirm older entries exist in `docs/logs/PROJECT_LOG_ARCHIVE.md`.
  - Confirm `AGENTS.md` includes the 30-entry archive rule.

---

- **Date:** 2026-02-07 (Pacific/Auckland)
- **Task:** Reduce active project log cap to 20 entries
- **Summary:**
  - Updated logging policy to keep only the latest 20 entries in `PROJECT_LOG.md`.
  - Archived older active entries into `docs/logs/PROJECT_LOG_ARCHIVE.md` to match the new cap.
- **Files changed:**
  - `AGENTS.md`
  - `PROJECT_LOG.md`
  - `docs/logs/PROJECT_LOG_ARCHIVE.md`
- **Commands run:**
  - `Get-Content -Raw AGENTS.md`
  - `Get-Content -Raw PROJECT_LOG.md`
  - `rg -n "30-entry|most recent 30|exceed 30" AGENTS.md`
  - PowerShell archive script (append entry + keep latest 20)
- **How to verify:**
  - Confirm `PROJECT_LOG.md` contains only the most recent 20 entries.
  - Confirm older entries are present in `docs/logs/PROJECT_LOG_ARCHIVE.md`.
  - Confirm `AGENTS.md` references a 20-entry cap.

---

- **Date:** 2026-02-07 (Pacific/Auckland)
- **Task:** Add admin role with owner-equivalent permissions
- **Summary:**
  - Added a new Supabase migration to allow `profiles.role = 'admin'` and apply owner-equivalent RLS behavior for admin users.
  - Updated app role gates so owner-only flows (logo management, instructor creation, assignment controls) also allow admins.
  - Updated create-instructor Edge Function and org-logo storage policy SQL to allow both owners and admins.
- **Files changed:**
  - `src/features/auth/roles.ts`
  - `src/navigation/screens/StudentEditScreen.tsx`
  - `src/navigation/screens/LessonEditScreen.tsx`
  - `src/navigation/screens/StudentSessionHistoryScreen.tsx`
  - `src/navigation/screens/SettingsScreen.tsx`
  - `src/navigation/screens/AddInstructorScreen.tsx`
  - `src/supabase/types.ts`
  - `supabase/migrations/010_admin_role.sql`
  - `supabase/functions/create-instructor/index.ts`
  - `supabase/storage/org-logos.sql`
  - `supabase/README.md`
  - `PROJECT_LOG.md`
  - `docs/logs/PROJECT_LOG_ARCHIVE.md`
- **Commands run:**
  - `npx tsc --noEmit`
- **How to verify:**
  - Apply `supabase/migrations/010_admin_role.sql` in Supabase SQL Editor.
  - Set one profile role to `admin` and confirm admin can create instructors and change org logo.
  - Confirm instructor permissions remain restricted to assigned records.

---

- **Date:** 2026-02-07 (Pacific/Auckland)
- **Task:** Add drawer sign-out with confirmation
- **Summary:**
  - Added a `Sign out` action in the sidebar menu above the bottom divider/settings block.
  - Added a confirmation alert (`Cancel` / `Sign out`) before signing out.
  - On confirmation, triggers auth sign-out so the app returns to the login flow.
- **Files changed:**
  - `src/navigation/components/AppDrawerContent.tsx`
  - `PROJECT_LOG.md`
  - `docs/logs/PROJECT_LOG_ARCHIVE.md`
- **Commands run:**
  - `npx tsc --noEmit`
- **How to verify:**
  - Open the drawer and confirm `Sign out` appears above the divider and `Settings`.
  - Tap `Sign out` and confirm the confirmation alert appears.
  - Tap `Cancel` and confirm you remain signed in.
  - Tap `Sign out` in the alert and confirm you are returned to `LoginScreen`.

---

- **Date:** 2026-02-07 (Pacific/Auckland)
- **Task:** Add delete actions and save confirmations for students/lessons
- **Summary:**
  - Excluded `admin` from assignable instructor options on `New student` and `New lesson` screens.
  - Added save confirmations for `Edit student` and for both `New lesson`/`Edit lesson` submissions.
  - Added permanent `Delete student` action on student profile and icon-only `Delete lesson` action on edit lesson header.
  - Added student/lesson delete API + query mutations and new RLS delete policies migration.
- **Files changed:**
  - `src/navigation/screens/StudentEditScreen.tsx`
  - `src/navigation/screens/LessonEditScreen.tsx`
  - `src/navigation/screens/StudentDetailScreen.tsx`
  - `src/features/students/api.ts`
  - `src/features/students/queries.ts`
  - `src/features/lessons/api.ts`
  - `src/features/lessons/queries.ts`
  - `supabase/migrations/011_students_lessons_delete_policies.sql`
  - `supabase/README.md`
  - `PROJECT_LOG.md`
  - `docs/logs/PROJECT_LOG_ARCHIVE.md`
- **Commands run:**
  - `npx tsc --noEmit`
- **How to verify:**
  - New student/new lesson: confirm admin users are not shown in assignable instructor options.
  - Edit student: tap `Save student` and confirm a save confirmation appears before update.
  - New/edit lesson: tap save/create and confirm confirmation appears before mutation.
  - Student profile: confirm red `Delete student` appears below archive/unarchive and deletes after confirmation.
  - Edit lesson: confirm top-right icon-only delete button appears and deletes after confirmation.
  - Apply `supabase/migrations/011_students_lessons_delete_policies.sql` before testing deletes against Supabase.

---

- **Date:** 2026-02-07 (Pacific/Auckland)
- **Task:** Refactor AGENTS.md using full project log history
- **Summary:**
  - Reviewed all entries in `PROJECT_LOG.md` and `docs/logs/PROJECT_LOG_ARCHIVE.md` to align instructions with current implemented behavior.
  - Replaced the oversized spec-style `AGENTS.md` with a concise operations guide focused on current app reality and durable working rules.
  - Preserved mandatory workflow items (MCP lookup expectations, migrations process, log/commit/verification requirements) while removing outdated or redundant sections.
- **Files changed:**
  - `AGENTS.md`
  - `PROJECT_LOG.md`
  - `docs/logs/INDEX.md`
  - `docs/logs/PROJECT_LOG_ARCHIVE.md`
- **Commands run:**
  - `Get-Content -Raw AGENTS.md`
  - `Get-Content -Raw PROJECT_LOG.md`
  - `Get-Content -Raw docs/logs/PROJECT_LOG_ARCHIVE.md`
  - `rg --no-heading "^- \\*\\*Date:\\*\\*|^- \\*\\*Task:\\*\\*" PROJECT_LOG.md docs/logs/PROJECT_LOG_ARCHIVE.md`
- **How to verify:**
  - Open `AGENTS.md` and confirm it is significantly shorter and references current roles (`owner`, `admin`, `instructor`) and current feature baseline.
  - Confirm `PROJECT_LOG.md` still contains 20 entries and includes this new entry at the bottom.
  - Confirm the oldest previously active entry now exists in `docs/logs/PROJECT_LOG_ARCHIVE.md`.

