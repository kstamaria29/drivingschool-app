# PROJECT_LOG.md

- **Date:** 2026-02-04 (Pacific/Auckland)
- **Task:** Initialize repo documentation
- **Summary:**
  - Added initial `AGENTS.md` with v1 scope, stack decisions, schema, RLS rules, UI priorities, and Codex instructions.
  - Added requirement to maintain this `PROJECT_LOG.md` after every task.
- **Files changed:**
  - `AGENTS.md`
  - `PROJECT_LOG.md`
- **Commands run:**
  - None
- **Verification:**
  - N/A (documentation only)
- **Notes/TODO:**
  - Next: run Codex task to bootstrap Expo project + Supabase migrations + auth/onboarding.

---

- **Date:** 2026-02-04 (Pacific/Auckland)
- **Task:** Bootstrap mobile app (Auth + Onboarding)
- **Summary:**
  - Initialized Expo React Native + TypeScript project structure and configured tablet portrait orientation.
  - Added NativeWind + Tailwind setup and introduced shared UI primitives (`Screen`, `AppText`, `AppButton`, `AppInput`, `AppCard`, `AppStack`).
  - Implemented React Navigation with `AuthStack` and `MainTabs`, plus an auth gate that checks Supabase session and routes first-time users into onboarding.
  - Added Supabase client setup for Expo/React Native (AsyncStorage + URL polyfill) and public env var wiring via `.env`.
  - Implemented email/password auth (sign in + sign up) and onboarding flow to create an organization + owner profile and optionally upload an org logo to Storage.
  - Added Supabase SQL migrations for `organizations`, `profiles`, `organization_settings`, required triggers, RLS policies, and onboarding RPC.
  - Added Storage bucket policy SQL for `org-logos` access rules (read within org; owner-only write).
  - Updated README with step-by-step Supabase setup + running instructions.
  - Fixed setup issues encountered during bootstrap:
    - TypeScript JSX config error (`Cannot use JSX unless the '--jsx' flag is provided`).
    - Metro bundling error for missing `babel-preset-expo`.
    - Supabase `gotrue-js` lock timeout warnings (singleton client + retry); silenced third-party SafeAreaView deprecation warning.
    - Supabase `profiles` policy recursion error (added follow-up migration to remove recursive RLS patterns).
- **Files changed (high level):**
  - App/config: `App.tsx`, `index.ts`, `app.json`, `package.json`, `tsconfig.json`, `.gitignore`, `.env.example`, `README.md`
  - NativeWind: `babel.config.js`, `metro.config.js`, `tailwind.config.js`, `global.css`, `nativewind-env.d.ts`, `declarations.d.ts`
  - UI primitives: `src/components/*`, `src/theme/theme.ts`, `src/utils/*`
  - Navigation/auth/onboarding: `src/navigation/*`, `src/features/auth/*`, `src/features/onboarding/*`, `src/providers/*`, `src/supabase/*`
  - Supabase SQL: `supabase/migrations/001_auth_onboarding.sql`, `supabase/migrations/002_fix_profiles_rls.sql`, `supabase/storage/org-logos.sql`
- **Commands run (representative):**
  - `npx create-expo-app@latest _tmp --template blank-typescript --yes --no-install`
  - `npm install`
  - `npm install nativewind`
  - `npx expo install react-native-reanimated react-native-safe-area-context react-native-gesture-handler react-native-screens`
  - `npm install @react-navigation/native @react-navigation/native-stack @react-navigation/bottom-tabs`
  - `npm install @supabase/supabase-js @tanstack/react-query react-hook-form zod @hookform/resolvers dayjs react-native-url-polyfill`
  - `npx expo install @react-native-async-storage/async-storage expo-image-picker`
  - `npm install --save-dev tailwindcss prettier-plugin-tailwindcss babel-preset-expo`
  - `npx tsc --noEmit`
- **Verification:**
  - TypeScript compile check via `npx tsc --noEmit` (local).

---

- **Date:** 2026-02-04 (Pacific/Auckland)
- **Task:** Make Lessons screen fully scrollable on phone
- **Summary:**
  - Switched to a single outer scroll container on phone-sized screens so the entire Lessons screen (header + calendar + agenda) scrolls together.
  - Kept tablet behavior: calendar stays visible while only the agenda area scrolls.
- **Files changed:**
  - `src/navigation/screens/LessonsListScreen.tsx`
  - `PROJECT_LOG.md`
- **Commands run:**
  - `npx tsc --noEmit`
- **Verification:**
  - On a phone device/simulator, swipe up anywhere on the Lessons screen and confirm the whole screen scrolls.
  - On a tablet device/simulator, confirm the calendar stays fixed and only the lesson list scrolls.
- **Notes/TODO:**
  - None.

---

- **Date:** 2026-02-04 (Pacific/Auckland)
- **Task:** Add split view for tablet landscape Lessons
- **Summary:**
  - Updated Lessons screen to use a two-column layout in tablet landscape: calendar on the left, agenda on the right.
  - Kept existing behavior on tablet portrait (calendar above agenda) and phones (single-page scroll).
- **Files changed:**
  - `src/navigation/screens/LessonsListScreen.tsx`
  - `PROJECT_LOG.md`
- **Commands run:**
  - `npx tsc --noEmit`
- **Verification:**
  - On a tablet in landscape, confirm calendar renders on the left and lesson list on the right with the list scrollable.
  - Rotate back to portrait and confirm the layout matches the previous (calendar above, agenda below).
- **Notes/TODO:**
  - None.

---

- **Date:** 2026-02-04 (Pacific/Auckland)
- **Task:** Fix LessonEditScreen hook order crash
- **Summary:**
  - Fixed React hook-order runtime error when opening an existing lesson by ensuring all hooks run before any early returns.
  - Moved the `useMemo` for `studentOptions` above the loading/error return paths.
- **Files changed:**
  - `src/navigation/screens/LessonEditScreen.tsx`
  - `PROJECT_LOG.md`
- **Commands run:**
  - `npx tsc --noEmit`
- **Verification:**
  - From Lessons, tap an existing lesson; confirm no "Rendered more hooks" error and the edit form loads.
- **Notes/TODO:**
  - None.

---

- **Date:** 2026-02-04 (Pacific/Auckland)
- **Task:** Fix Lessons screen scrolling on phone
- **Summary:**
  - Fixed the Lessons screen empty/error states being clipped on small screens by making the agenda area scrollable in all states.
  - Made the agenda `ScrollView` fill remaining height (`flex-1`) so it can actually scroll when the calendar leaves limited space on phones.
  - Added extra bottom padding to agenda scroll content so the last card isn't cut off.
- **Files changed:**
  - `src/navigation/screens/LessonsListScreen.tsx`
  - `PROJECT_LOG.md`
- **Commands run:**
  - `npx tsc --noEmit`
- **Verification:**
  - On a phone-sized simulator/device, open Lessons with 0 lessons and confirm you can scroll to fully see the "No lessons" card.
  - Confirm the lessons list also scrolls normally when lessons exist.
- **Notes/TODO:**
  - None.

---

- **Date:** 2026-02-04 (Pacific/Auckland)
- **Task:** Fix calendar week layout (7 days)
- **Summary:**
  - Fixed month calendar grid wrapping so weeks always render 7 columns (Mon–Sun) instead of occasionally wrapping at 6.
  - Rendered the calendar as 6 explicit week rows (7 cells each) to avoid flex-wrap rounding issues.
- **Files changed:**
  - `src/components/CalendarMonth.tsx`
  - `PROJECT_LOG.md`
- **Commands run:**
  - `npx tsc --noEmit`
- **Verification:**
  - Open Lessons tab and confirm each week row shows 7 days (Mon–Sun) with correct alignment (e.g. Feb 2026 should start on Sun).
- **Notes/TODO:**
  - None.

---

- **Date:** 2026-02-04 (Pacific/Auckland)
- **Task:** Make calendar the main Lessons screen
- **Summary:**
  - Embedded the month calendar directly into `LessonsListScreen` and removed the Today/This Week toggle and separate calendar screen.
  - Lessons now default to showing today's agenda under the calendar, with day selection driving the list.
- **Files changed:**
  - `src/navigation/LessonsStackNavigator.tsx`
  - `src/navigation/screens/LessonsListScreen.tsx`
  - `PROJECT_LOG.md`
- **Commands run:**
  - `npx tsc --noEmit`
- **Verification:**
  - TypeScript compile check via `npx tsc --noEmit` (local).

---

- **Date:** 2026-02-04 (Pacific/Auckland)
- **Task:** Redo navigation UI (sidebar + hamburger) + Home + Settings uploads
- **Summary:**
  - Replaced bottom tabs with a responsive drawer layout: permanent collapsible sidebar on tablet landscape, hamburger drawer on tablet portrait/phones.
  - Added `Home` as the post-login landing screen (dashboard-style) and added an `Assessments` placeholder screen (no assessment features implemented).
  - Added Settings options to upload organization logo (owner-only) and user profile photo (avatars bucket + RPC).
  - Added Supabase migration + storage policies for profile avatars and created `supabase/README.md`.
- **Files changed:**
  - `src/navigation/RootNavigation.tsx`
  - `src/navigation/MainDrawerNavigator.tsx`
  - `src/navigation/HomeStackNavigator.tsx`
  - `src/navigation/SettingsStackNavigator.tsx`
  - `src/navigation/AssessmentsStackNavigator.tsx`
  - `src/navigation/components/AppDrawerContent.tsx`
  - `src/navigation/components/HeaderButtons.tsx`
  - `src/navigation/useNavigationLayout.ts`
  - `src/navigation/screens/HomeScreen.tsx`
  - `src/navigation/screens/SettingsScreen.tsx`
  - `src/navigation/screens/AssessmentsComingSoonScreen.tsx`
  - `src/components/Avatar.tsx`
  - `src/components/AppDivider.tsx`
  - `src/features/auth/current-user.tsx`
  - `src/features/organization/api.ts`
  - `src/features/organization/queries.ts`
  - `src/features/profiles/api.ts`
  - `src/features/profiles/queries.ts`
  - `src/supabase/types.ts`
  - `supabase/migrations/005_profile_avatars.sql`
  - `supabase/storage/avatars.sql`
  - `supabase/README.md`
  - `README.md`
  - `package.json`
  - `PROJECT_LOG.md`
- **Commands run:**
  - None (dependencies were not installed in this environment).
- **Verification:**
  - Run `npm install`, then `npx tsc --noEmit`.
  - On tablet landscape: confirm sidebar is permanent and collapsible (icons-only when collapsed).
  - On tablet portrait/phone: confirm hamburger opens left drawer and avatar button shows on the right.
  - In Settings: upload org logo (owner) and profile photo; confirm drawer/header reflect updates.
- **Notes/TODO:**
  - `Assessments` remains a placeholder only (v1 explicitly excludes assessment features).

---

- **Date:** 2026-02-04 (Pacific/Auckland)
- **Task:** Fix Worklets version mismatch (Expo runtime crash)
- **Summary:**
  - Pinned `react-native-worklets` to `0.5.1` (dependency + npm overrides) to match the native Worklets version bundled with the current app runtime.
- **Files changed:**
  - `package.json`
  - `PROJECT_LOG.md`
- **Commands run:**
  - None
- **Verification:**
  - Delete `node_modules` and reinstall: `npm install`
  - Start Metro with a clean cache: `npx expo start -c`
  - Confirm the red Worklets mismatch screen no longer appears.
- **Notes/TODO:**
  - If using a custom dev client, rebuild the dev client after dependency changes.

---

- **Date:** 2026-02-04 (Pacific/Auckland)
- **Task:** Align AGENTS.md with new navigation UI
- **Summary:**
  - Updated the navigation spec to describe the responsive drawer layout (sidebar in tablet landscape, hamburger in portrait/mobile) and set `HomeScreen` as the default post-login landing screen.
  - Clarified `Assessments` as a placeholder-only route in v1 (no assessment features).
- **Files changed:**
  - `AGENTS.md`
  - `PROJECT_LOG.md`
- **Commands run:**
  - None
- **Verification:**
  - Open `AGENTS.md` and confirm sections 8/10/11 match the current app navigation.
- **Notes/TODO:**
  - None

---

- **Date:** 2026-02-04 (Pacific/Auckland)
- **Task:** Add top padding to drawer menus
- **Summary:**
  - Increased top padding for the drawer content so both the permanent sidebar and hamburger drawer menus start lower (`pt-10`).
- **Files changed:**
  - `src/navigation/components/AppDrawerContent.tsx`
  - `PROJECT_LOG.md`
- **Commands run:**
  - None
- **Verification:**
  - Open the drawer on phone/tablet portrait and confirm menu content starts lower.
  - On tablet landscape, confirm the sidebar content has the same top spacing.
- **Notes/TODO:**
  - None

---

- **Date:** 2026-02-04 (Pacific/Auckland)
- **Task:** Fix image upload "Network request failed"
- **Summary:**
  - Switched logo/avatar uploads to use `expo-image-picker` base64 data instead of `fetch(asset.uri)`, avoiding failures with `content://` URIs on Android.
- **Files changed:**
  - `src/utils/base64.ts`
  - `src/navigation/screens/OnboardingCreateOrgScreen.tsx`
  - `src/navigation/screens/SettingsScreen.tsx`
  - `src/features/onboarding/api.ts`
  - `src/features/organization/api.ts`
  - `src/features/profiles/api.ts`
  - `PROJECT_LOG.md`
- **Commands run:**
  - None
- **Verification:**
  - Open Settings and upload an organization logo + profile photo; confirm both uploads succeed and images render in the drawer/header.
  - Complete onboarding with a logo selected; confirm the org logo uploads successfully.
- **Notes/TODO:**
  - None

---

- **Date:** 2026-02-04 (Pacific/Auckland)
- **Task:** Fix Blob upload + ImagePicker deprecation
- **Summary:**
  - Updated Supabase Storage uploads to pass `Uint8Array` directly (avoids RN Blob limitation: “Creating blobs from ArrayBuffer…”).
  - Switched `expo-image-picker` usage away from deprecated `ImagePicker.MediaTypeOptions`.
- **Files changed:**
  - `src/features/onboarding/api.ts`
  - `src/features/organization/api.ts`
  - `src/features/profiles/api.ts`
  - `src/navigation/screens/SettingsScreen.tsx`
  - `PROJECT_LOG.md`
- **Commands run:**
  - None
- **Verification:**
  - Upload org logo + profile photo and confirm uploads succeed without Blob errors or ImagePicker deprecation warnings.
- **Notes/TODO:**
  - None

---

- **Date:** 2026-02-04 (Pacific/Auckland)
- **Task:** Remove org logo border radius
- **Summary:**
  - Made the organization logo render as a square (no rounded corners) across the drawer header, Settings, and onboarding preview.
- **Files changed:**
  - `src/navigation/components/AppDrawerContent.tsx`
  - `src/navigation/screens/SettingsScreen.tsx`
  - `src/navigation/screens/OnboardingCreateOrgScreen.tsx`
  - `PROJECT_LOG.md`
- **Commands run:**
  - None
- **Verification:**
  - Open the drawer and Settings and confirm the org logo has sharp corners.
- **Notes/TODO:**
  - None

---

- **Date:** 2026-02-04 (Pacific/Auckland)
- **Task:** Fix nested screen name warning
- **Summary:**
  - Renamed stack screen route names so drawer routes don't nest screens with the same name (removes `Home, Home > Home` warning; also prevents the same issue for Settings/Assessments).
- **Files changed:**
  - `src/navigation/HomeStackNavigator.tsx`
  - `src/navigation/screens/HomeScreen.tsx`
  - `src/navigation/SettingsStackNavigator.tsx`
  - `src/navigation/AssessmentsStackNavigator.tsx`
  - `PROJECT_LOG.md`
- **Commands run:**
  - None
- **Verification:**
  - Start the app and confirm the terminal no longer warns about nested screens with the same name.
- **Notes/TODO:**
  - None

---

- **Date:** 2026-02-04 (Pacific/Auckland)
- **Task:** Switch app font to Poppins
- **Summary:**
  - Added Poppins via Expo Google Fonts and block app render until fonts are loaded.
  - Updated `AppText` and `AppInput` primitives to use Poppins weights (regular/medium/semibold) without relying on `fontWeight`.
- **Files changed:**
  - `App.tsx`
  - `src/theme/fonts.ts`
  - `src/components/AppText.tsx`
  - `src/components/AppInput.tsx`
  - `src/theme/theme.ts`
  - `package.json`
  - `PROJECT_LOG.md`
- **Commands run:**
  - None
- **Verification:**
  - Install deps: `npx expo install @expo-google-fonts/poppins expo-font`
  - Start: `npx expo start -c`
  - Confirm text + inputs render in Poppins across Home/Lessons/Students/Settings.
- **Notes/TODO:**
  - None

---

- **Date:** 2026-02-04 (Pacific/Auckland)
- **Task:** Fix Poppins imports for Expo Google Fonts
- **Summary:**
  - Fixed `App.tsx` to import Poppins weights from `@expo-google-fonts/poppins` (the installed package exports fonts from its root, not `.../400Regular` subpaths).
- **Files changed:**
  - `App.tsx`
  - `PROJECT_LOG.md`
- **Commands run:**
  - None
- **Verification:**
  - Run `npx expo start -c` and confirm Metro no longer reports `Unable to resolve "@expo-google-fonts/poppins/400Regular"`.
- **Notes/TODO:**
  - None

---

- **Date:** 2026-02-04 (Pacific/Auckland)
- **Task:** Fix Lessons screen layout (no forced scrolling)
- **Summary:**
  - Added `AppButton` `width` prop to support `auto` sizing in horizontal rows while preserving full-width by default.
  - Refactored `LessonsListScreen` to keep the calendar visible and make only the agenda list scrollable.
  - Updated row button usage across Lessons/Students screens to avoid overflow and pushed-down content.
- **Files changed:**
  - `src/theme/theme.ts`
  - `src/components/AppButton.tsx`
  - `src/navigation/screens/LessonsListScreen.tsx`
  - `src/navigation/screens/StudentsListScreen.tsx`
  - `src/navigation/screens/StudentEditScreen.tsx`
  - `src/navigation/screens/LessonEditScreen.tsx`
  - `PROJECT_LOG.md`
- **Commands run:**
  - `npx tsc --noEmit`
- **Verification:**
  - TypeScript compile check via `npx tsc --noEmit` (local).
  - Manual run verified up to login/onboarding flow; Supabase RLS recursion fixed via follow-up migration.
- **Notes/TODO:**
  - Students and Lessons features are intentionally not implemented yet (per v1 build order).

---

- **Date:** 2026-02-04 (Pacific/Auckland)
- **Task:** Implement Students feature (v1: CRUD + archive)
- **Summary:**
  - Added `students` table migration with RLS policies (owner: org-wide; instructor: assigned only) and updated_at trigger.
  - Implemented typed Students data layer (`features/students/api.ts` + `features/students/queries.ts`) and Zod form schema.
  - Added Profiles query helper for owner instructor assignment picker.
  - Built Students stack navigation and screens:
    - `StudentsListScreen` (active/archived toggle + create)
    - `StudentDetailScreen` (view + archive/unarchive)
    - `StudentEditScreen` (create/edit form with assignment rules)
  - Wired Students stack into `MainTabs` (removed old placeholder).
  - Updated README to include `003_students.sql` migration and mark Students as implemented.
- **Files changed:**
  - `supabase/migrations/003_students.sql`
  - `src/supabase/types.ts`
  - `src/features/students/api.ts`
  - `src/features/students/queries.ts`
  - `src/features/students/schemas.ts`
  - `src/features/profiles/api.ts`
  - `src/features/profiles/queries.ts`
  - `src/navigation/MainTabsNavigator.tsx`
  - `src/navigation/StudentsStackNavigator.tsx`
  - `src/navigation/screens/StudentsListScreen.tsx`
  - `src/navigation/screens/StudentDetailScreen.tsx`
  - `src/navigation/screens/StudentEditScreen.tsx`
  - `README.md`
  - `PROJECT_LOG.md`
- **Commands run:**
  - `npx tsc --noEmit`
- **Verification:**
  - TypeScript compile check via `npx tsc --noEmit` (local).
- **Notes/TODO:**
  - Next: implement Lessons scheduling (Today view + edit) per v1.

---

- **Date:** 2026-02-04 (Pacific/Auckland)
- **Task:** Implement Lessons scheduling (v1: Today/Week + create/edit)
- **Summary:**
  - Added `lessons` table migration with constraints, indexes, updated_at trigger, and RLS policies (owner: org-wide; instructor: own lessons only).
  - Enforced lesson integrity in RLS: lesson instructor must be in org and match the student's assigned instructor.
  - Implemented typed Lessons data layer (`features/lessons/api.ts` + `features/lessons/queries.ts`) and Zod form schema using Day.js for time calculations.
  - Added `LessonsStack` navigation with `LessonsListScreen` (Today/This Week) and `LessonEditScreen` (create/edit).
  - Added `AppBadge` primitive for lesson status chips and wired Lessons stack into MainTabs.
  - Updated README to include `004_lessons.sql` migration and mark Lessons as implemented.
- **Files changed:**
  - `supabase/migrations/004_lessons.sql`
  - `src/supabase/types.ts`
  - `src/features/lessons/api.ts`
  - `src/features/lessons/queries.ts`
  - `src/features/lessons/schemas.ts`
  - `src/components/AppBadge.tsx`
  - `src/navigation/LessonsStackNavigator.tsx`
  - `src/navigation/MainTabsNavigator.tsx`
  - `src/navigation/screens/LessonsListScreen.tsx`
  - `src/navigation/screens/LessonEditScreen.tsx`
  - `README.md`
  - `PROJECT_LOG.md`
- **Commands run:**
  - `npx tsc --noEmit`
- **Verification:**
  - TypeScript compile check via `npx tsc --noEmit` (local).
- **Notes/TODO:**
  - Next: polish lesson time input UX (date/time pickers) if needed, without adding heavy deps.

---

- **Date:** 2026-02-04 (Pacific/Auckland)
- **Task:** Add calendar view for Lessons
- **Summary:**
  - Added an in-app month calendar screen for Lessons with per-day lesson counts and an agenda list for the selected day.
  - Added navigation entry points from `LessonsListScreen` and the calendar screen to create a lesson on the selected date.
  - Fixed mojibake in Lessons time/date separators by normalizing the en-dash character.
- **Files changed:**
  - `src/components/CalendarMonth.tsx`
  - `src/navigation/LessonsStackNavigator.tsx`
  - `src/navigation/screens/LessonsCalendarScreen.tsx`
  - `src/navigation/screens/LessonsListScreen.tsx`
  - `src/navigation/screens/LessonEditScreen.tsx`
  - `README.md`
  - `PROJECT_LOG.md`
- **Commands run:**
  - `npx tsc --noEmit`
- **Verification:**
  - TypeScript compile check via `npx tsc --noEmit` (local).
